<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Module2_concentration • rfasst</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Module2_concentration">
<meta property="og:description" content="rfasst">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-12345678-0"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-12345678-0');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rfasst</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fas fa-clipboard-list"></span>
     
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Module1_emissions.html">Module1 emissions</a>
    </li>
    <li>
      <a href="../articles/Module2_concentration.html">Module2 concentration</a>
    </li>
    <li>
      <a href="../articles/Module3_health.html">Module3 health</a>
    </li>
    <li>
      <a href="../articles/Module4_agriculture.html">Module4 agriculture</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bc3LC/rfasst" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Module2_concentration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bc3LC/rfasst/blob/HEAD/vignettes/Module2_concentration.Rmd" class="external-link"><code>vignettes/Module2_concentration.Rmd</code></a></small>
      <div class="hidden name"><code>Module2_concentration.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="description">Description<a class="anchor" aria-label="anchor" href="#description"></a>
</h2>
<p>The functions that form this module take the emission sets per
TM5-FASST region and year generated in Module 1 (by
<code>m1_emissions_rescale</code>), and estimate the fine particulate
matter (PM2.5) and ozone (O3) concentration levels for each period and
TM5-FASST region. In particular the package reports the following range
of PM2.5 and O3 indicators:</p>
<ul>
<li>Fine particulate matter (PM2.5) concentration levels
(<code>m2_get_conc_pm25</code>)</li>
<li>Raw ozone concentration levels (<code>m2_get_conc_o3</code>)</li>
<li>Maximum 6-monthly running average of daily maximum hourly O3 (M6M,
also known as 6mDMA1) (<code>m2_get_conc_m6m</code>). This indicator is
used to compute health impacts attributable to exposure to ozone (see <a href="https://www.nejm.org/doi/full/10.1056/nejmoa0803894" class="external-link">Jerret et al
2009</a>)</li>
</ul>
<p>The module includes two additional functions to estimate crop losses
associated with high ozone concentration levels, suing two different
mettrics described in <a href="https://www.sciencedirect.com/science/article/pii/S1352231008009424" class="external-link">Van
Dingenen et al 2009</a>: * Accumulated daytime hourly O3 concentration
above a threshold of 40 ppbV (AOT40) (<code>m2_get_conc_aot40</code>) *
Seasonal mean daytime O3 concentration (<code>m2_get_conc_mi</code>)</p>
<p>The code below shows an example to get PM2.5 concentration
levels:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bc3LC/rfasst" class="external-link">rfasst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span> <span class="va">db_path</span><span class="op">&lt;-</span><span class="st">"path_to_your_gcam_database"</span></span>
<span> <span class="va">query_path</span><span class="op">&lt;-</span><span class="st">"path_to_your_gcam_queries_file"</span></span>
<span> <span class="va">db_name</span><span class="op">&lt;-</span><span class="st">"name of the database"</span></span>
<span> <span class="va">prj_name</span><span class="op">&lt;-</span><span class="st">"name for a Project to add extracted results to"</span> <span class="co"># (any name should work, avoid spaces just in case) </span></span>
<span> <span class="va">scen_name</span><span class="op">&lt;-</span><span class="st">"name of the GCAM scenario"</span></span>
<span> <span class="va">queries</span><span class="op">&lt;-</span><span class="st">"Name of the query file"</span> <span class="co"># (the package includes a default query file that includes all the queries required in every function in the packae, "queries_rfasst.xml")</span></span>
<span> <span class="co"># saveOutput: Writes the files.By default = T</span></span>
<span> <span class="co"># map: Produce the maps. By default = F</span></span>
<span> <span class="co"># </span></span>
<span></span>
<span>  <span class="co"># To write the csv files into the output folder:</span></span>
<span></span>
<span>     <span class="fu"><a href="../reference/m2_get_conc_pm25.html">m2_get_conc_pm25</a></span><span class="op">(</span><span class="va">db_path</span>, <span class="va">query_path</span>, <span class="va">db_name</span>, <span class="va">prj_name</span>,</span>
<span>                      <span class="va">scen_name</span>, <span class="va">queries</span>, saveOutput <span class="op">=</span> <span class="cn">T</span>, map <span class="op">=</span> <span class="cn">F</span>, anim <span class="op">=</span> <span class="cn">T</span>, recompute <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co"># To save as data frame pm2.5 concentration levels by TM5-FASST region in year 2050:</span></span>
<span></span>
<span>     <span class="va">pm25.conc.2050</span><span class="op">&lt;-</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu"><a href="../reference/m2_get_conc_pm25.html">m2_get_conc_pm25</a></span><span class="op">(</span><span class="va">db_path</span>,<span class="va">query_path</span>,<span class="va">db_name</span>,<span class="va">prj_name</span>,<span class="va">scen_name</span>,<span class="va">queries</span>, saveOutput <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="fl">2050</span><span class="op">)</span> </span>
<span>                         </span>
<span>     <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pm25.conc.2050</span><span class="op">)</span></span></code></pre></div>
In addition, for all these functions, the package allows to produce
different figures and/or animations, generated using the <a href="https://github.com/JGCRI/rmap" class="external-link">rmap</a> package documented in the
following <a href="jgcri.github.io/rmap/">page</a>. To generate these
maps, the user needs to include the <code>map = T</code> parameter, and
they will be generated and stored in the corresponding output
sub-directory. As an example for this module, the following map shows
the PM2.5 concentrations in 2050: <!-------------------------->
<!-------------------------->
<p align="center" style="font-size:18px;">
<em>PM2.5 concntration by region in 2050 (ug/m3)</em>
</p>
<p align="center">
<img src="https://raw.githubusercontent.com/JGCRI/rfasst/main/vignettes/vignetteFigs/PM2.5_concentration_2050.png"></p>
<!-------------------------->
<!-------------------------->
<p>As indicated in the documentation of TM5-FASST <a href="https://acp.copernicus.org/articles/18/16173/2018/acp-18-16173-2018-discussion.html" class="external-link">Van
Dingenen et al 2018</a>,estimates of PM2.5 and O3 concentration levels
in a receptor region driven by the emissions of different precursors in
different sources are based on parametrizations of meteorology and
atmospheric chemistry drawn from the more complex TM5 model. In summary,
concentration of a pollutant <span class="math inline">\(j\)</span>, in
region <span class="math inline">\(y\)</span>, from all the precursors
(<span class="math inline">\(i\)</span>) emitted in all regions (<span class="math inline">\(x_k\)</span>), is calculated as:</p>
<p><span class="math display">\[C_j (y)=C_{j,base}
(y)+∑_{k=1}^{n_x}∑_{i=1}^{n_i}SRC_{i,j} [x_k,y]\cdot[E_i
(x_k)-E_{i,base} (x_k )]\]</span></p>
<ul>
<li><p><span class="math inline">\(C_{j,base} (y)\)</span> is the
base-run concentration level of pollutant j in region y, pre-computed
with TM5.</p></li>
<li><p><span class="math inline">\(E_{i,base} (x_k)\)</span> are the
base-run precursor i emissions in region <span class="math inline">\(x_k\)</span></p></li>
<li><p><span class="math inline">\(SRC_{i,j} [x_k,y]\)</span> = the
<span class="math inline">\(i\)</span>–to-<span class="math inline">\(j\)</span> source-receptor coefficient for source
region <span class="math inline">\(x_k\)</span> and receptor region y,
pre-computed from a 20% emission reduction of component i in region
<span class="math inline">\(x_k\)</span> relative to the
base-run</p></li>
<li><p><span class="math inline">\(E_i (x_k)\)</span> are the emissions
of precursor i in region <span class="math inline">\(x_k\)</span> in the
analyzed scenario.</p></li>
</ul>
<p>Following this equation, base-run emissions and concentrations, and
source-receptor coefficient matrixes need to be combined with emissions
pathways for the analyzed scenario. The package includes the following
input information:</p>
<ul>
<li>Source-receptor coefficient matrixes (SRC):
<ul>
<li>PM2.5 Source-receptor matrixes:
<ul>
<li>SO4: SO2, NOx and NH3</li>
<li>NO3: NOx, SO2, and NH3</li>
<li>NH4: NH3, NOx and SO2</li>
<li>BC: BC_POP</li>
<li>POM: POM_POP</li>
</ul>
</li>
<li>O3 Source-receptor matrixes:
<ul>
<li>For O3 exposure (O3): NOx, NMVOC and SO2</li>
<li>For health calculations: M6M (6mDMA1): NOx, NMVOC, SO2 and CH4</li>
<li>For agricultural damages:
<ul>
<li>AOT40: NOx, NMVOC, SO2 and CH4</li>
<li>Mi (M7 and M12): NOx, NMVOC, SO2 and CH4</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The package also includes the base emission and concentration levels
for all these indicators.</p>
<p>In addition, primary PM2.5 emissions (BC and POM) are assumed to have
a more direct influence in urban (more dense) areas, so the
emission-concentration relation for these two pollutants is modified
using adjustment coefficients that are included in the package.</p>
</div>
<div class="section level2">
<h2 id="downscaling-pm2-5-concentrations">Downscaling PM2.5 concentrations<a class="anchor" aria-label="anchor" href="#downscaling-pm2-5-concentrations"></a>
</h2>
<p>The new release of rfasst (rfasst-v2.0) allows the user to get
high-resolution (0.01 x 0.01 km) gridded concentration maps. The gridded
PM2.5 maps are based on a static downscaling approach, based on observed
PM2.5 data from <a href="https://sedac.ciesin.columbia.edu/data/set/sdei-global-annual-gwr-pm2-5-modis-misr-seawifs-aod-v4-gl-03" class="external-link">Hammer
et al 2020</a>. As indicated in their publication, this dataset includes
“annual concentrations (micrograms per cubic meter) of all composition
ground-level fine particulate matter (PM2.5). This data set combines”AOD
retrievals from multiple satellite algorithms including the NASA
MODerate resolution Imaging Spectroradiometer Collection 6.1 (MODIS
C6.1), Multi-angle Imaging SpectroRadiometer Version 23 (MISRv23), MODIS
Multi-Angle Implementation of Atmospheric Correction Collection 6 (MAIAC
C6), and the Sea-Viewing Wide Field-of-View Sensor (SeaWiFS) Deep Blue
Version 4.”</p>
<p>We use this data to compute static “grid-to-region” coefficients that
are saved as a raster file and provided with the package
(<code>pm25_weights_rast</code>).</p>
<p>Once the region-level PM2.5 concentration levels are calculated
(using the <code>m2_get_conc_pm25</code> function), the obtained
dataframe can be rasterized to a 0.01 x 0.01 resolution grid map.</p>
<p>Then, we combine the rasterized output with the pre-computed
grid-to-region downscaling coefficients to obtain the final gridded
output.</p>
<p>The downscaling procedure can be activated by setting the parameter
<code>downscale = T</code>. This requires significantly more computing
time so it is set to <code>F</code>by default. In addition, the user can
write the produced raster file as a georeferenced “tiff” file by setting
<code>saveRaster_grid = T</code> (with the associated increase in the
computing time).</p>
<p>Finally, the updated tool also enables to re-aggregate the gridded
output to a new resolution of interest for the user. In this version,
the tool only includes to re-aggregate gridded results to the <a href="https://www.europarl.europa.eu/factsheets/en/sheet/99/common-classification-of-territorial-units-for-statistics-nuts-" class="external-link">“NUTS3”</a>
aggregation by the European Commission. In order to get additional
resolutions, the user would need to load their shape file (as a
SpatVector object) and make some changes in the corresponding code
(Lines 493-527). Future model version will try to make this procedure
more user-friendly, which is a challenge due to the large size of these
shape files. The re-aggregation of the gridded data to new resolutions
can be activated with the following boolean: <code>agg_grid = T</code>.
Likewise, the re-aggregated results can be written as a
<code>.csv</code> file by setting <code>save_AggGrid = T</code>.</p>
<p>An example is provided in the code below:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bc3LC/rfasst" class="external-link">rfasst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span> <span class="va">db_path</span><span class="op">&lt;-</span><span class="st">"path_to_your_gcam_database"</span></span>
<span> <span class="va">query_path</span><span class="op">&lt;-</span><span class="st">"path_to_your_gcam_queries_file"</span></span>
<span> <span class="va">db_name</span><span class="op">&lt;-</span><span class="st">"name of the database"</span></span>
<span> <span class="va">prj_name</span><span class="op">&lt;-</span><span class="st">"name for a Project to add extracted results to"</span> <span class="co"># (any name should work, avoid spaces just in case) </span></span>
<span> <span class="va">scen_name</span><span class="op">&lt;-</span><span class="st">"name of the GCAM scenario"</span></span>
<span> <span class="va">queries</span><span class="op">&lt;-</span><span class="st">"Name of the query file"</span> <span class="co"># (the package includes a default query file that includes all the queries required in every function in the packae, "queries_rfasst.xml")</span></span>
<span></span>
<span>  <span class="co"># Produce downscaled/gridded outputs and save them as a raster file.</span></span>
<span>  <span class="co"># Also, re-aggregate the gridded output to NUTS3 resolution (and save the re-aggrgeated dataframe into a csv file)</span></span>
<span></span>
<span>     <span class="fu"><a href="../reference/m2_get_conc_pm25.html">m2_get_conc_pm25</a></span><span class="op">(</span><span class="va">db_path</span>, <span class="va">query_path</span>, <span class="va">db_name</span>, <span class="va">prj_name</span>,</span>
<span>                      <span class="va">scen_name</span>, <span class="va">queries</span>, saveOutput <span class="op">=</span> <span class="cn">F</span>, map <span class="op">=</span> <span class="cn">F</span>, anim <span class="op">=</span> <span class="cn">T</span>, recompute <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                           downscale <span class="op">=</span> <span class="cn">T</span>, saveRaster_grid <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                           agg_grid <span class="op">=</span> <span class="st">"NUTS3"</span>, save_AggGrid <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jon Sampedro, Zarrar Khan, Chris Vernon, Clàudia Rodés-Bachs.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
